#!/bin/bash
#
# This script corresponds with the wiki page :
# https://wiki.analog.com/resources/fpga/xilinx/zynqmp_ddr4_update
#

declare -a to_patch=(
	"# PSU_DDRC_MSTR_DEVICE_CONFIG                                                     0x1"
	"#(OFFSET, MASK, VALUE)      (0XFD070000, 0xE30FBE3DU ,0x41040010U)  *"
	"mask_write 0XFD070000 0xE30FBE3D 0x41040010"
	"# PSU_DDRC_RFSHTMG_T_RFC_MIN                                                      0x8b"
	"#(OFFSET, MASK, VALUE)      (0XFD070064, 0x0FFF83FFU ,0x0081808BU)  *"
	"mask_write 0XFD070064 0x0FFF83FF 0x0081808B"
	"# PSU_DDRC_DRAMTMG4_T_RRD                                                         0x3"
	"#(OFFSET, MASK, VALUE)      (0XFD070110, 0x1F0F0F1FU ,0x08030309U)  *"
	"mask_write 0XFD070110 0x1F0F0F1F 0x08030309"
	"# PSU_DDRC_DRAMTMG8_T_XS_FAST_X32                                                 0x3"
	"# PSU_DDRC_DRAMTMG8_T_XS_ABORT_X32                                                0x3"
	"# PSU_DDRC_DRAMTMG8_T_XS_X32                                                      0x6"
	"#(OFFSET, MASK, VALUE)      (0XFD070120, 0x7F7F7F7FU ,0x03030D06U)  *"
	"mask_write 0XFD070120 0x7F7F7F7F 0x03030D06"
	"# PSU_DDRC_DRAMTMG9_T_RRD_S                                                       0x2"
	"#(OFFSET, MASK, VALUE)      (0XFD070124, 0x40070F3FU ,0x0002020BU)  *"
	"mask_write 0XFD070124 0x40070F3F 0x0002020B"
	"# PSU_DDRC_DRAMTMG11_POST_MPSM_GAP_X32                                            0x11"
	"#(OFFSET, MASK, VALUE)      (0XFD07012C, 0x7F1F031FU ,0x1107010EU)  *"
	"mask_write 0XFD07012C 0x7F1F031F 0x1107010E"
	"# PSU_DDRC_ADDRMAP1_ADDRMAP_BANK_B1                                               0xa"
	"# PSU_DDRC_ADDRMAP1_ADDRMAP_BANK_B0                                               0xa"
	"#(OFFSET, MASK, VALUE)      (0XFD070204, 0x001F1F1FU ,0x001F0A0AU)  *"
	"mask_write 0XFD070204 0x001F1F1F 0x001F0A0A"
	"# PSU_DDRC_ADDRMAP5_ADDRMAP_ROW_B11                                               0x8"
	"# PSU_DDRC_ADDRMAP5_ADDRMAP_ROW_B1                                                0x8"
	"# PSU_DDRC_ADDRMAP5_ADDRMAP_ROW_B0                                                0x8"
	"#(OFFSET, MASK, VALUE)      (0XFD070214, 0x0F0F0F0FU ,0x080F0808U)  *"
	"mask_write 0XFD070214 0x0F0F0F0F 0x080F0808"
	"# PSU_DDRC_ADDRMAP6_ADDRMAP_ROW_B15                                               0xf"
	"# PSU_DDRC_ADDRMAP6_ADDRMAP_ROW_B14                                               0x8"
	"# PSU_DDRC_ADDRMAP6_ADDRMAP_ROW_B13                                               0x8"
	"# PSU_DDRC_ADDRMAP6_ADDRMAP_ROW_B12                                               0x8"
	"#(OFFSET, MASK, VALUE)      (0XFD070218, 0x8F0F0F0FU ,0x0F080808U)  *"
	"mask_write 0XFD070218 0x8F0F0F0F 0x0F080808"
	"# PSU_DDRC_ADDRMAP8_ADDRMAP_BG_B1                                                 0x8"
	"#(OFFSET, MASK, VALUE)      (0XFD070220, 0x00001F1FU ,0x00000808U)  *"
	"mask_write 0XFD070220 0x00001F1F 0x00000808"
	"# PSU_DDRC_ADDRMAP9_ADDRMAP_ROW_B5                                                0x8"
	"# PSU_DDRC_ADDRMAP9_ADDRMAP_ROW_B4                                                0x8"
	"# PSU_DDRC_ADDRMAP9_ADDRMAP_ROW_B3                                                0x8"
	"# PSU_DDRC_ADDRMAP9_ADDRMAP_ROW_B2                                                0x8"
	"#(OFFSET, MASK, VALUE)      (0XFD070224, 0x0F0F0F0FU ,0x08080808U)  *"
	"mask_write 0XFD070224 0x0F0F0F0F 0x08080808"
	"# PSU_DDRC_ADDRMAP10_ADDRMAP_ROW_B9                                               0x8"
	"# PSU_DDRC_ADDRMAP10_ADDRMAP_ROW_B8                                               0x8"
	"# PSU_DDRC_ADDRMAP10_ADDRMAP_ROW_B7                                               0x8"
	"# PSU_DDRC_ADDRMAP10_ADDRMAP_ROW_B6                                               0x8"
	"#(OFFSET, MASK, VALUE)      (0XFD070228, 0x0F0F0F0FU ,0x08080808U)  *"
	"mask_write 0XFD070228 0x0F0F0F0F 0x08080808"
	"# PSU_DDRC_ADDRMAP11_ADDRMAP_ROW_B10                                              0x8"
	"#(OFFSET, MASK, VALUE)      (0XFD07022C, 0x0000000FU ,0x00000008U)  *"
	"mask_write 0XFD07022C 0x0000000F 0x00000008"
	"# PSU_DDR_PHY_DTPR0_TRRD                                                          0x6"
	"#(OFFSET, MASK, VALUE)      (0XFD080110, 0xFFFFFFFFU ,0x06240F08U)  *"
	"mask_write 0XFD080110 0xFFFFFFFF 0x06240F08"
	"# PSU_DDR_PHY_DTPR4_TRFC                                                          0x116"
	"#(OFFSET, MASK, VALUE)      (0XFD080120, 0xFFFFFFFFU ,0x01162B07U)  *"
	"mask_write 0XFD080120 0xFFFFFFFF 0x01162B07")

declare -a patched=(
	"# PSU_DDRC_MSTR_DEVICE_CONFIG                                                     0x2"
	"#(OFFSET, MASK, VALUE)      (0XFD070000, 0xE30FBE3DU ,0x81040010U)  *"
	"mask_write 0XFD070000 0xE30FBE3D 0x81040010"
	"# PSU_DDRC_RFSHTMG_T_RFC_MIN                                                      0xbb"
	"#(OFFSET, MASK, VALUE)      (0XFD070064, 0x0FFF83FFU ,0x008180BBU)  *"
	"mask_write 0XFD070064 0x0FFF83FF 0x008180BB"
	"# PSU_DDRC_DRAMTMG4_T_RRD                                                         0x4"
	"#(OFFSET, MASK, VALUE)      (0XFD070110, 0x1F0F0F1FU ,0x08030409U)  *"
	"mask_write 0XFD070110 0x1F0F0F1F 0x08030409"
	"# PSU_DDRC_DRAMTMG8_T_XS_FAST_X32                                                 0x4"
	"# PSU_DDRC_DRAMTMG8_T_XS_ABORT_X32                                                0x4"
	"# PSU_DDRC_DRAMTMG8_T_XS_X32                                                      0x7"
	"#(OFFSET, MASK, VALUE)      (0XFD070120, 0x7F7F7F7FU ,0x04040D07U)  *"
	"mask_write 0XFD070120 0x7F7F7F7F 0x04040D07"
	"# PSU_DDRC_DRAMTMG9_T_RRD_S                                                       0x3"
	"#(OFFSET, MASK, VALUE)      (0XFD070124, 0x40070F3FU ,0x0002030BU)  *"
	"mask_write 0XFD070124 0x40070F3F 0x0002030B"
	"# PSU_DDRC_DRAMTMG11_POST_MPSM_GAP_X32                                            0x12"
	"#(OFFSET, MASK, VALUE)      (0XFD07012C, 0x7F1F031FU ,0x1207010EU)  *"
	"mask_write 0XFD07012C 0x7F1F031F 0x1207010E"
	"# PSU_DDRC_ADDRMAP1_ADDRMAP_BANK_B1                                               0x9"
	"# PSU_DDRC_ADDRMAP1_ADDRMAP_BANK_B0                                               0x9"
	"#(OFFSET, MASK, VALUE)      (0XFD070204, 0x001F1F1FU ,0x001F0909U)  *"
	"mask_write 0XFD070204 0x001F1F1F 0x001F0909"
	"# PSU_DDRC_ADDRMAP5_ADDRMAP_ROW_B11                                               0x7"
	"# PSU_DDRC_ADDRMAP5_ADDRMAP_ROW_B1                                                0x7"
	"# PSU_DDRC_ADDRMAP5_ADDRMAP_ROW_B0                                                0x7"
	"#(OFFSET, MASK, VALUE)      (0XFD070214, 0x0F0F0F0FU ,0x070F0707U)  *"
	"mask_write 0XFD070214 0x0F0F0F0F 0x070F0707"
	"# PSU_DDRC_ADDRMAP6_ADDRMAP_ROW_B15                                               0x7"
	"# PSU_DDRC_ADDRMAP6_ADDRMAP_ROW_B14                                               0x7"
	"# PSU_DDRC_ADDRMAP6_ADDRMAP_ROW_B13                                               0x7"
	"# PSU_DDRC_ADDRMAP6_ADDRMAP_ROW_B12                                               0x7"
	"#(OFFSET, MASK, VALUE)      (0XFD070218, 0x8F0F0F0FU ,0x07070707U)  *"
	"mask_write 0XFD070218 0x8F0F0F0F 0x07070707"
	"# PSU_DDRC_ADDRMAP8_ADDRMAP_BG_B1                                                 0x1f"
	"#(OFFSET, MASK, VALUE)      (0XFD070220, 0x00001F1FU ,0x00001F08U)  *"
	"mask_write 0XFD070220 0x00001F1F 0x00001F08"
	"# PSU_DDRC_ADDRMAP9_ADDRMAP_ROW_B5                                                0x7"
	"# PSU_DDRC_ADDRMAP9_ADDRMAP_ROW_B4                                                0x7"
	"# PSU_DDRC_ADDRMAP9_ADDRMAP_ROW_B3                                                0x7"
	"# PSU_DDRC_ADDRMAP9_ADDRMAP_ROW_B2                                                0x7"
	"#(OFFSET, MASK, VALUE)      (0XFD070224, 0x0F0F0F0FU ,0x07070707U)  *"
	"mask_write 0XFD070224 0x0F0F0F0F 0x07070707"
	"# PSU_DDRC_ADDRMAP10_ADDRMAP_ROW_B9                                               0x7"
	"# PSU_DDRC_ADDRMAP10_ADDRMAP_ROW_B8                                               0x7"
	"# PSU_DDRC_ADDRMAP10_ADDRMAP_ROW_B7                                               0x7"
	"# PSU_DDRC_ADDRMAP10_ADDRMAP_ROW_B6                                               0x7"
	"#(OFFSET, MASK, VALUE)      (0XFD070228, 0x0F0F0F0FU ,0x07070707U)  *"
	"mask_write 0XFD070228 0x0F0F0F0F 0x07070707"
	"# PSU_DDRC_ADDRMAP11_ADDRMAP_ROW_B10                                              0x7"
	"#(OFFSET, MASK, VALUE)      (0XFD07022C, 0x0000000FU ,0x00000007U)  *"
	"mask_write 0XFD07022C 0x0000000F 0x00000007"
	"# PSU_DDR_PHY_DTPR0_TRRD                                                          0x7"
	"#(OFFSET, MASK, VALUE)      (0XFD080110, 0xFFFFFFFFU ,0x07240F08U)  *"
	"mask_write 0XFD080110 0xFFFFFFFF 0x07240F08"
	"# PSU_DDR_PHY_DTPR4_TRFC                                                          0x176"
	"#(OFFSET, MASK, VALUE)      (0XFD080120, 0xFFFFFFFFU ,0x01762B07U)  *"
	"mask_write 0XFD080120 0xFFFFFFFF 0x01762B07")

if [[( -z "$1" ) || ($1 != *"psu_init.tcl") ]];
then
	echo "Please specify the path to the \"psu_init.tcl\" file"
	echo "For example : ./ddr_patch.sh /analog/zcu102/system_hw_platform_0/psu_init.tcl"
else
	for index in ${!to_patch[*]};
	do
		if grep -q  "${to_patch[$index]}" $1;
		then
			sed -i "s/${to_patch[$index]}/${patched[$index]}/g" $1 || {
				echo "Patching failed"
				exit 1
			}
		else
			echo "Pathing failed or already patched!"
			exit 1
		fi
	done
	echo "Done"
fi
